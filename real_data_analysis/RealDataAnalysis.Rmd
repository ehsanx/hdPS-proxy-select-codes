---
title: "Real Data Analysis"
output: pdf_document
---

```{r setup, cache=TRUE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(autoCovariateSelection)
require(dplyr)
require(cobalt)
require(WeightIt)
library(tidyverse)
library(ggplot2)
library(lmtest)
library(MASS)
library(Boruta)
library(GA)
library(mclust)
library(penalizedSVM)
library(xgboost)
library(caret)
require(autoCovariateSelection)
library(randomForest)
library(leaps)
library(grid)
```

```{r loading data, warning=FALSE, cache=TRUE, include=FALSE}
load("data/analytic3cycles.RData")

analytic <- data.complete
idx <- analytic$id
outcome <- as.numeric(analytic$diabetes == "Yes") 
exposure <- as.numeric(analytic$obese == "Yes")

domain <- "dx"
analytic.dfx <- as.data.frame(cbind(idx, exposure, outcome, domain))
dat.proxy.long <- subset(dat.proxy.long, 
                         icd10 != "E66") # Overweight and obesity
dat.proxy.long <- subset(dat.proxy.long, 
                         icd10 != "O24") # Gestational diabetes mellitus
dat.proxy.long <- subset(dat.proxy.long, 
                         icd10 != "E10") # Type 1 diabetes mellitus
dat.proxy.long <- subset(dat.proxy.long, 
                         icd10 != "E11") # Type 2 diabetes mellitus
proxy.var.long <- dat.proxy.long
proxy.var.long$idx <- proxy.var.long$id
proxy.var.long$id <- NULL
dfx <- merge(analytic.dfx, proxy.var.long, by = "idx")
# ------------------- now the proxy data was combined to the A and Y

# basetable <- dfx %>% select(idx, exposure, outcome) %>% distinct()
basetable <- dfx[, c(1:3)] %>% distinct()
patientIds <- basetable$idx
length(patientIds)
# ------------------- number of observations

save(dfx, patientIds, basetable, file = "data/dfx.RData")
load(file = "data/dfx.RData")

step1 <- get_candidate_covariates(df = dfx, 
                                  domainVarname = "domain",
                                  eventCodeVarname = "icd10", 
                                  patientIdVarname = "idx",
                                  patientIdVector = patientIds,
                                  n = 200, 
                                  min_num_patients = 20)
out1 <- step1$covars_data
# ------------------- top 200 prevalent icd10 with min 20 patients

step2 <- get_recurrence_covariates(df = out1, 
                                   patientIdVarname = "idx",
                                   eventCodeVarname = "icd10", 
                                   patientIdVector = patientIds)
out2 <- step2$recurrence_data

exposure <- "obese"
outcome <- "diabetes" 
investigator.specified.covariates <- 
  c(# Demographic
    "age.cat", "sex", "education", "race", 
    "marital", "income", "born", "year",
    
    # health history related variables/access
    "diabetes.family.history", "medical.access",
    
    # behavioral
    "smoking", "diet.healthy", "physical.activity", "sleep",
    
    # Laboratory 
    "uric.acid", "protein.total", "bilirubin.total", "phosphorus",
    "sodium", "potassium", "globulin", "calcium.total", 
    "systolicBP", "diastolicBP", "high.cholesterol"
  )
covform <- paste0(investigator.specified.covariates, collapse = "+")
out.formula <- as.formula(paste0("outcome", "~", "exposure"))
```

```{r summary results, warning=FALSE, cache=TRUE, echo=FALSE}
if (nrow(basetable) == length(unique(basetable$idx))) {
  paste0("The sample size is ", nrow(basetable), ".")
}

paste0("The exposure prevalence is ", 
       round(sum(basetable$exposure == 1)/nrow(basetable), 3),
       ".")

paste0("The outcome prevalence is ", 
       round(sum(basetable$outcome == 1)/nrow(basetable), 3),
       ".")
```

**Method 1: Kitchen Sink**
```{r kitchen sink OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
hdps.dim <- out2

load("data/analytic3cycles.RData")
hdps.dim$id <- hdps.dim$idx
hdps.dim$idx <- NULL
hdps.data <- merge(data.complete[,c("id",
                                    outcome, 
                                    exposure, 
                                    investigator.specified.covariates)], 
                   hdps.dim, by = "id")

hdps.data$exposure <- as.numeric(I(hdps.data$obese=='Yes'))
hdps.data$outcome <- as.numeric(I(hdps.data$diabetes=='Yes'))

start_time <- Sys.time()
proxy_ks <- names(out2[,-1])
proxyform <- paste0(proxy_ks, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_ks <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_ks <- glm(out.formula,
           data = hdps.data,
           weights = W.out_ks$weights,
           family= binomial(link = "logit"))
sum.OR_ks <- summary(fit.OR_ks)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_ks <- confint(fit.OR_ks, level = 0.95)["exposure", ]
sum.ci.OR_ks <- c(sum.OR_ks, ci.OR_ks)
sum.ci.OR_ks <- c(exp(sum.ci.OR_ks[1]), sum.ci.OR_ks[2], sum.ci.OR_ks[4:5])
names(sum.ci.OR_ks) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_ks) <- c("OR", "SE", "lower", "upper")

fit.RD_ks <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_ks$weights,
                     family=gaussian(link= "identity"))
sum.RD_ks  <- summary(fit.RD_ks)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_ks[2]<- sqrt(sandwich::sandwich(fit.RD_ks)[2,2])
ci.RD_ks <- confint(fit.RD_ks, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_ks  <- c(sum.RD_ks[1:2], ci.RD_ks)
names(sum.ci.RD_ks) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by kitchen sink method is ", 
       length(proxy_ks), ".")
print("The Odds Ratio by Ks formula method: ")
round(sum.ci.OR_ks, 3)
print("The Risk Difference by Ks formula method: ")
round(sum.ci.RD_ks, 3)
end_time <- Sys.time()
elapsed.time_ks <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 2: Bross Formula**
```{r bross OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
start_time <- Sys.time()
out3 <- get_prioritised_covariates(df = out2,
                                   patientIdVarname = "idx", 
                                   exposureVector = basetable$exposure,
                                   outcomeVector = basetable$outcome,
                                   patientIdVector = patientIds, 
                                   k = 100)
hdps.dim <- out3$autoselected_covariate_df

load("data/analytic3cycles.RData")
hdps.dim$id <- hdps.dim$idx
hdps.dim$idx <- NULL
hdps.data <- merge(data.complete[,c("id",
                                    outcome, 
                                    exposure, 
                                    investigator.specified.covariates)], 
                   hdps.dim, by = "id")

hdps.data$exposure <- as.numeric(I(hdps.data$obese=='Yes'))
hdps.data$outcome <- as.numeric(I(hdps.data$diabetes=='Yes'))

proxy_bross <- names(out3$autoselected_covariate_df[,-1])
proxyform <- paste0(proxy_bross, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_bross <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_bross <- glm(out.formula,
           data = hdps.data,
           weights = W.out_bross$weights,
           family= binomial(link = "logit"))
sum.OR_bross <- summary(fit.OR_bross)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_bross <- confint(fit.OR_bross, level = 0.95)["exposure", ]
sum.ci.OR_bross <- c(sum.OR_bross, ci.OR_bross)
sum.ci.OR_bross <- c(exp(sum.ci.OR_bross[1]), sum.ci.OR_bross[2], sum.ci.OR_bross[4:5])
names(sum.ci.OR_bross) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_bross) <- c("OR", "SE", "lower", "upper")

fit.RD_bross <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_bross$weights,
                     family=gaussian(link= "identity"))
sum.RD_bross  <- summary(fit.RD_bross)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_bross[2]<- sqrt(sandwich::sandwich(fit.RD_bross)[2,2])
ci.RD_bross <- confint(fit.RD_bross, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_bross  <- c(sum.RD_bross[1:2], ci.RD_bross)
names(sum.ci.RD_bross) <- c("RD", "SE", "lower", "upper")

print("The number of proxy variables selected by bross formula method is 100.")
print("The Odds Ratio by Bross formula method: ")
round(sum.ci.OR_bross, 3)
print("The Risk Difference by Bross formula method: ")
round(sum.ci.RD_bross, 3)
end_time <- Sys.time()
elapsed.time_bross <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 3: Hybrid Bross Formula & Lasso**
```{r hybrid OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
start_time <- Sys.time()
proxy.list <- proxy_bross
covarsTfull <- c(investigator.specified.covariates, proxy_bross)
Y.form <- as.formula(paste0(c("outcome ~ exposure", 
                              covarsTfull), collapse = "+") )
covar.mat <- model.matrix(Y.form, data = hdps.data)[,-1]
hybrid.fit <- glmnet::cv.glmnet(y = hdps.data$outcome, 
                               x = covar.mat, 
                               type.measure='mse',
                               family="binomial",
                               alpha = 1, 
                               nfolds = 5)
coef.fit <- coef(hybrid.fit,s='lambda.min',exact=TRUE)
sel.variables <- row.names(coef.fit)[which(as.numeric(coef.fit)!=0)]
proxy_hybrid <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_hybrid, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_hybrid <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_hybrid <- glm(out.formula,
           data = hdps.data,
           weights = W.out_hybrid$weights,
           family= binomial(link = "logit"))
sum.OR_hybrid <- summary(fit.OR_hybrid)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_hybrid <- confint(fit.OR_hybrid, level = 0.95)["exposure", ]
sum.ci.OR_hybrid <- c(sum.OR_hybrid, ci.OR_hybrid)
sum.ci.OR_hybrid <- c(exp(sum.ci.OR_hybrid[1]), sum.ci.OR_hybrid[2], sum.ci.OR_hybrid[4:5])
names(sum.ci.OR_hybrid) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_hybrid) <- c("OR", "SE", "lower", "upper")

fit.RD_hybrid <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_hybrid$weights,
                     family=gaussian(link= "identity"))
sum.RD_hybrid  <- summary(fit.RD_hybrid)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_hybrid[2]<- sqrt(sandwich::sandwich(fit.RD_hybrid)[2,2])
ci.RD_hybrid <- confint(fit.RD_hybrid, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_hybrid  <- c(sum.RD_hybrid[1:2], ci.RD_hybrid)
names(sum.ci.RD_hybrid) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by hybrid method is ", 
       length(proxy_hybrid), ".")
print("The Odds Ratio by Hybrid formula method: ")
round(sum.ci.OR_hybrid, 3)
print("The Risk Difference by Hybrid formula method: ")
round(sum.ci.RD_hybrid, 3)
end_time <- Sys.time()
elapsed.time_hybrid <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

```{r prepare for alternatives, warning=FALSE, cache=TRUE}
hdps.dim <- out2

load("data/analytic3cycles.RData")
hdps.dim$id <- hdps.dim$idx
hdps.dim$idx <- NULL
hdps.data <- merge(data.complete[,c("id",
                                    outcome, 
                                    exposure, 
                                    investigator.specified.covariates)], 
                   hdps.dim, by = "id")

hdps.data$exposure <- as.numeric(I(hdps.data$obese=='Yes'))
hdps.data$outcome <- as.numeric(I(hdps.data$diabetes=='Yes'))

proxy.list <- names(out2[,-1])
proxyform <- paste0(proxy.list, collapse = "+")
covform <- paste0(investigator.specified.covariates, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))
covarsTfull <- c(investigator.specified.covariates, proxy.list)
Y.form <- as.formula(paste0(c("outcome~ exposure", 
                              covarsTfull), collapse = "+") )
full.formula <- as.formula(paste0("outcome~exposure+",
                                  rhsformula,
                                  collapse = "+"))
```

**Method 4: Pure Lasso**
```{r lasso OR & RD, warning=FALSE, cache=TRUE}
set.seed(42)
start_time <- Sys.time()
covar.mat <- model.matrix(Y.form, data = hdps.data)[,-1]
lasso.fit <- glmnet::cv.glmnet(y = hdps.data$outcome, 
                               x = covar.mat, 
                               type.measure='mse',
                               family="binomial",
                               alpha = 1, 
                               nfolds = 5)
coef.fit <- coef(lasso.fit,s='lambda.min',exact=TRUE)
sel.variables <- row.names(coef.fit)[which(as.numeric(coef.fit)!=0)]
proxy_lasso <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_lasso, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_lasso <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_lasso <- glm(out.formula,
           data = hdps.data,
           weights = W.out_lasso$weights,
           family= binomial(link = "logit"))
sum.OR_lasso <- summary(fit.OR_lasso)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_lasso <- confint(fit.OR_lasso, level = 0.95)["exposure", ]
sum.ci.OR_lasso <- c(sum.OR_lasso, ci.OR_lasso)
sum.ci.OR_lasso <- c(exp(sum.ci.OR_lasso[1]), sum.ci.OR_lasso[2], sum.ci.OR_lasso[4:5])
names(sum.ci.OR_lasso) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_lasso) <- c("OR", "SE", "lower", "upper")

fit.RD_lasso <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_lasso$weights,
                     family=gaussian(link= "identity"))
sum.RD_lasso  <- summary(fit.RD_lasso)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_lasso[2]<- sqrt(sandwich::sandwich(fit.RD_lasso)[2,2])
ci.RD_lasso <- confint(fit.RD_lasso, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_lasso  <- c(sum.RD_lasso[1:2], ci.RD_lasso)
names(sum.ci.RD_lasso) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by lasso method is ", length(proxy_lasso), ".")
print("The Odds Ratio by Lasso formula method: ")
round(sum.ci.OR_lasso, 3)
print("The Risk Difference by Lasso formula method: ")
round(sum.ci.RD_lasso, 3)
end_time <- Sys.time()
elapsed.time_lasso <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 5: Elastic Net**
```{r enet OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
start_time <- Sys.time()
covar.mat <- model.matrix(Y.form, data = hdps.data)[,-1]
enet.fit <- glmnet::cv.glmnet(y = hdps.data$outcome, 
                               x = covar.mat, 
                               type.measure='mse',
                               family="binomial",
                               alpha = 0.5, 
                               nfolds = 5)
coef.fit <- coef(enet.fit,s='lambda.min',exact=TRUE)
sel.variables <- row.names(coef.fit)[which(as.numeric(coef.fit)!=0)]
proxy_enet <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_enet, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_enet <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_enet <- glm(out.formula,
           data = hdps.data,
           weights = W.out_enet$weights,
           family= binomial(link = "logit"))
sum.OR_enet <- summary(fit.OR_enet)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_enet <- confint(fit.OR_enet, level = 0.95)["exposure", ]
sum.ci.OR_enet <- c(sum.OR_enet, ci.OR_enet)
sum.ci.OR_enet <- c(exp(sum.ci.OR_enet[1]), sum.ci.OR_enet[2], sum.ci.OR_enet[4:5])
names(sum.ci.OR_enet) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_enet) <- c("OR", "SE", "lower", "upper")

fit.RD_enet <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_enet$weights,
                     family=gaussian(link= "identity"))
sum.RD_enet  <- summary(fit.RD_enet)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_enet[2]<- sqrt(sandwich::sandwich(fit.RD_enet)[2,2])
ci.RD_enet <- confint(fit.RD_enet, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_enet  <- c(sum.RD_enet[1:2], ci.RD_enet)
names(sum.ci.RD_enet) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by elastic net model is ", 
       length(proxy_enet), ".")
print("The Odds Ratio by Enet formula method: ")
round(sum.ci.OR_enet, 3)
print("The Risk Difference by Enet formula method: ")
round(sum.ci.RD_enet, 3)
end_time <- Sys.time()
elapsed.time_enet <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 6: Random Forest**
```{r rf OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
start_time <- Sys.time()

rf_model <- randomForest(outcome ~ ., data = hdps.data, importance = TRUE)
rf_importance <- importance(rf_model)
important_features_rf <- rownames(rf_importance)[order(rf_importance[, 1], decreasing = TRUE)]
proxy_rf <- important_features_rf[important_features_rf %in% proxy.list][1:100]
proxyform <- paste0(proxy_rf, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_rf <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_rf <- glm(out.formula,
           data = hdps.data,
           weights = W.out_rf$weights,
           family= binomial(link = "logit"))
sum.OR_rf <- summary(fit.OR_rf)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_rf <- confint(fit.OR_rf, level = 0.95)["exposure", ]
sum.ci.OR_rf <- c(sum.OR_rf, ci.OR_rf)
sum.ci.OR_rf <- c(exp(sum.ci.OR_rf[1]), sum.ci.OR_rf[2], sum.ci.OR_rf[4:5])
names(sum.ci.OR_rf) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_rf) <- c("OR", "SE", "lower", "upper")

fit.RD_rf <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_rf$weights,
                     family=gaussian(link= "identity"))
sum.RD_rf  <- summary(fit.RD_rf)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_rf[2]<- sqrt(sandwich::sandwich(fit.RD_rf)[2,2])
ci.RD_rf <- confint(fit.RD_rf, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_rf  <- c(sum.RD_rf[1:2], ci.RD_rf)
names(sum.ci.RD_rf) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by random forest is ", 
       length(proxy_rf), ".")
print("The Odds Ratio by Rf formula method: ")
round(sum.ci.OR_rf, 3)
print("The Risk Difference by Rf formula method: ")
round(sum.ci.RD_rf, 3)
end_time <- Sys.time()
elapsed.time_rf <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 7: XGBoost**
```{r xgb OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
start_time <- Sys.time()
xgb_fit <- xgboost(data = covar.mat, label = hdps.data$outcome, 
                    max.depth = 20, eta = 1, nthread = 2, nrounds = 5, 
                    objective = "binary:logistic")
xgb_imp <- xgb.importance(model = xgb_fit)
# xgb.plot.importance(importance_matrix = xgb_imp)
proxy_xgboost <- xgb_imp$Feature
proxy_xgboost <- proxy.list[proxy.list %in% proxy_xgboost]
proxyform <- paste0(proxy_xgboost, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_xgboost <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_xgboost <- glm(out.formula,
           data = hdps.data,
           weights = W.out_xgboost$weights,
           family= binomial(link = "logit"))
sum.OR_xgboost <- summary(fit.OR_xgboost)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_xgboost <- confint(fit.OR_xgboost, level = 0.95)["exposure", ]
sum.ci.OR_xgboost <- c(sum.OR_xgboost, ci.OR_xgboost)
sum.ci.OR_xgboost <- c(exp(sum.ci.OR_xgboost[1]), sum.ci.OR_xgboost[2], sum.ci.OR_xgboost[4:5])
names(sum.ci.OR_xgboost) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_xgboost) <- c("OR", "SE", "lower", "upper")

fit.RD_xgboost <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_xgboost$weights,
                     family=gaussian(link= "identity"))
sum.RD_xgboost  <- summary(fit.RD_xgboost)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_xgboost[2]<- sqrt(sandwich::sandwich(fit.RD_xgboost)[2,2])
ci.RD_xgboost <- confint(fit.RD_xgboost, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_xgboost  <- c(sum.RD_xgboost[1:2], ci.RD_xgboost)
names(sum.ci.RD_xgboost) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by elastic net model is ", 
       length(proxy_xgboost), ".")
print("The Odds Ratio by Xgboost formula method: ")
round(sum.ci.OR_xgboost, 3)
print("The Risk Difference by Xgboost formula method: ")
round(sum.ci.RD_xgboost, 3)
end_time <- Sys.time()
elapsed.time_xgboost <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 8.1: Stepwise - Forward Selection**
```{r forward OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
full.num.var <- length(proxy.list)+length(investigator.specified.covariates)
stepwise_forward <- regsubsets(full.formula, 
                               data = hdps.data, 
                               method = "forward", 
                               nvmax = full.num.var, 
                               nbest = 10)
summary_stepwise <- summary(stepwise_forward)
best_model <- which.max(summary_stepwise$adjr2)
sel.variables <- names(summary_stepwise$which[best_model,])[summary_stepwise$which[best_model,]]
proxy_forward <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_forward, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_forward <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_forward <- glm(out.formula,
           data = hdps.data,
           weights = W.out_forward$weights,
           family= binomial(link = "logit"))
sum.OR_forward <- summary(fit.OR_forward)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_forward <- confint(fit.OR_forward, level = 0.95)["exposure", ]
sum.ci.OR_forward <- c(sum.OR_forward, ci.OR_forward)
sum.ci.OR_forward <- c(exp(sum.ci.OR_forward[1]), sum.ci.OR_forward[2], sum.ci.OR_forward[4:5])
names(sum.ci.OR_forward) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_forward) <- c("OR", "SE", "lower", "upper")

fit.RD_forward <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_forward$weights,
                     family=gaussian(link= "identity"))
sum.RD_forward  <- summary(fit.RD_forward)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_forward[2]<- sqrt(sandwich::sandwich(fit.RD_forward)[2,2])
ci.RD_forward <- confint(fit.RD_forward, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_forward  <- c(sum.RD_forward[1:2], ci.RD_forward)
names(sum.ci.RD_forward) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by elastic net model is ", 
       length(proxy_forward), ".")
print("The Odds Ratio by Forward formula method: ")
round(sum.ci.OR_forward, 3)
print("The Risk Difference by Forward formula method: ")
round(sum.ci.RD_forward, 3)
end_time <- Sys.time()
elapsed.time_forward <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 8.2: Stepwise - Backward Elimination**
```{r backward OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
full.num.var <- length(proxy.list)+length(investigator.specified.covariates)
stepwise_backward <- regsubsets(full.formula, 
                               data = hdps.data, 
                               method = "backward", 
                               nvmax = full.num.var, 
                               nbest = 10)
summary_stepwise <- summary(stepwise_backward)
best_model <- which.max(summary_stepwise$adjr2)
sel.variables <- names(summary_stepwise$which[best_model,])[summary_stepwise$which[best_model,]]
proxy_backward <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_backward, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_backward <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_backward <- glm(out.formula,
           data = hdps.data,
           weights = W.out_backward$weights,
           family= binomial(link = "logit"))
sum.OR_backward <- summary(fit.OR_backward)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_backward <- confint(fit.OR_backward, level = 0.95)["exposure", ]
sum.ci.OR_backward <- c(sum.OR_backward, ci.OR_backward)
sum.ci.OR_backward <- c(exp(sum.ci.OR_backward[1]), sum.ci.OR_backward[2], sum.ci.OR_backward[4:5])
names(sum.ci.OR_backward) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_backward) <- c("OR", "SE", "lower", "upper")

fit.RD_backward <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_backward$weights,
                     family=gaussian(link= "identity"))
sum.RD_backward  <- summary(fit.RD_backward)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_backward[2]<- sqrt(sandwich::sandwich(fit.RD_backward)[2,2])
ci.RD_backward <- confint(fit.RD_backward, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_backward  <- c(sum.RD_backward[1:2], ci.RD_backward)
names(sum.ci.RD_backward) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by elastic net model is ", 
       length(proxy_backward), ".")
print("The Odds Ratio by Backward formula method: ")
round(sum.ci.OR_backward, 3)
print("The Risk Difference by Backward formula method: ")
round(sum.ci.RD_backward, 3)
end_time <- Sys.time()
elapsed.time_backward <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

**Method 9: Genetic algorithm (GA)**
```{r ga OR & RD, warning=FALSE, cache=TRUE, echo=FALSE}
set.seed(42)
start_time <- Sys.time()
gaOpt <- function(vars, IV.train, DV.train) {
	varNames <- colnames(IV.train) #getting names of all variables
	selectedVarNames <- varNames[vars == "1"] # getting names of selected vars from GA
	gaSolutionData <- IV.train[,selectedVarNames] # keeping only those selected vars

	gaDat <- cbind(gaSolutionData,DV.train) # combining selected variables with outcome variable
	gaMod <- glm(DV.train ~ ., family = "binomial", data = gaDat) #build model
	gaProb <- predict(gaMod, IV.train, type = "response") # get probabilities
	gaPred <- ifelse(gaProb >= .8, 1, 0) # get predicted 0s and 1s

	ari <- adjustedRandIndex(gaPred, DV.train)
	return(ari)
}

ga.solution <- ga(fitness = function(vars)
 gaOpt(vars=vars, 
       IV.train=data.frame(covar.mat),
       DV.train=hdps.data$outcome),
 type = "binary", 
 nBits = ncol(covar.mat),
 names = colnames(covar.mat), 
 seed = 42,
 run=5)

allVarNames <- colnames(covar.mat)
sel.variables <- allVarNames[ga.solution@solution[1,]==1]
proxy_ga <- proxy.list[proxy.list %in% sel.variables]
proxyform <- paste0(proxy_ga, collapse = "+")
rhsformula <- paste0(c(covform, proxyform), collapse = "+")
ps.formula <- as.formula(paste0("exposure", "~", rhsformula))

W.out_ga <- weightit(ps.formula, 
                  data = hdps.data, 
                  estimand = "ATE",
                  method = "ps")
fit.OR_ga <- glm(out.formula,
           data = hdps.data,
           weights = W.out_ga$weights,
           family= binomial(link = "logit"))
sum.OR_ga <- summary(fit.OR_ga)$coef["exposure",
                                 c("Estimate", 
                                   "Std. Error", 
                                   "Pr(>|z|)")]
ci.OR_ga <- confint(fit.OR_ga, level = 0.95)["exposure", ]
sum.ci.OR_ga <- c(sum.OR_ga, ci.OR_ga)
sum.ci.OR_ga <- c(exp(sum.ci.OR_ga[1]), sum.ci.OR_ga[2], sum.ci.OR_ga[4:5])
names(sum.ci.OR_ga) <- c("Odds Ratio", "Std. Error", "2.5 %", "97.5 %")
names(sum.ci.OR_ga) <- c("OR", "SE", "lower", "upper")

fit.RD_ga <- glm(out.formula,
                     data= hdps.data,
                     weights= W.out_ga$weights,
                     family=gaussian(link= "identity"))
sum.RD_ga  <- summary(fit.RD_ga)$coef["exposure",
                                           c("Estimate",
                                             "Std. Error",
                                             "Pr(>|t|)")]
sum.RD_ga[2]<- sqrt(sandwich::sandwich(fit.RD_ga)[2,2])
ci.RD_ga <- confint(fit.RD_ga, "exposure", level = 0.95,  method = "hc1")
sum.ci.RD_ga  <- c(sum.RD_ga[1:2], ci.RD_ga)
names(sum.ci.RD_ga) <- c("RD", "SE", "lower", "upper")

paste0("The number of proxy variables selected by elastic net model is ", 
       length(proxy_ga), ".")
print("The Odds Ratio by Ga formula method: ")
round(sum.ci.OR_ga, 3)
print("The Risk Difference by Ga formula method: ")
round(sum.ci.RD_ga, 3)
end_time <- Sys.time()
elapsed.time_ga <- as.numeric(difftime(end_time, start_time, units = "secs"))
```

```{r running time for methods, warning=FALSE, cache=TRUE, echo=FALSE}
elapsed_times <- data.frame(elapsed_time = numeric(10))
elapsed_times[1,1] <- elapsed.time_ks
elapsed_times[2,1] <- elapsed.time_bross
elapsed_times[3,1] <- elapsed.time_hybrid
elapsed_times[4,1] <- elapsed.time_lasso
elapsed_times[5,1] <- elapsed.time_enet
elapsed_times[6,1] <- elapsed.time_rf
elapsed_times[7,1] <- elapsed.time_xgboost
elapsed_times[8,1] <- elapsed.time_forward
elapsed_times[9,1] <- elapsed.time_backward
elapsed_times[10,1] <- elapsed.time_ga
rownames(elapsed_times) <- c("kitchen sink", "bross", "hybird",
                             "lasso", "enet", "rf", "xgboost",
                             "forward", "backward", "ga")
elapsed_times
```

Comparing the Results:
```{r results for number of proxies, warning=FALSE, cache=TRUE}
methods <- c("kitchen sink", "bross", "hybrid", 
             "lasso", "enet", 
             "rf", "xgboost", 
             "forward", "backward", 
             "ga")

num.proxy_all <- data.frame(num.of.proxy = c(length(proxy_ks),
                                         length(proxy_bross), 
                                         length(proxy_hybrid),
                                         length(proxy_lasso),
                                         length(proxy_enet), 
                                         length(proxy_rf),
                                         length(proxy_xgboost),
                                         length(proxy_forward),
                                         length(proxy_backward),
                                         length(proxy_ga)),
                            num.proxy.in.common = c(NA,
                                                    length(proxy_bross[proxy_bross %in% proxy_bross]),
                                                    length(proxy_hybrid[proxy_hybrid %in% proxy_bross]),
                                                    length(proxy_lasso[proxy_lasso %in% proxy_bross]),
                                                    length(proxy_enet[proxy_enet %in% proxy_bross]),
                                                    length(proxy_rf[proxy_rf %in% proxy_bross]),
                                                    length(proxy_xgboost[proxy_xgboost %in% proxy_bross]),
                                                    length(proxy_forward[proxy_forward %in% proxy_bross]),
                                                    length(proxy_backward[proxy_backward %in% proxy_bross]),
                                                    length(proxy_ga[proxy_ga %in% proxy_bross])))
rownames(num.proxy_all) <-  methods

num.proxy_all$pct.in.common <- num.proxy_all$num.proxy.in.common / num.proxy_all$num.of.proxy

proxy.common.1to1 <- data.frame(ini = rep(NA, 10))

for (i in 1:10) {
  col_name <- methods[i]
  na.i <- 1
  na <- c()
  while (na.i < i) {
    na <- c(na, NA)
    na.i <- na.i + 1
  }
  if (col_name == "kitchen sink") {
    col_name <- "ks"
  }
  num_common <- c(length(proxy_ks[proxy_ks %in% get(paste0("proxy_",col_name))]),
                  length(proxy_bross[proxy_bross %in% get(paste0("proxy_",col_name))]),
                  length(proxy_hybrid[proxy_hybrid %in% get(paste0("proxy_",col_name))]),
                  length(proxy_lasso[proxy_lasso %in% get(paste0("proxy_",col_name))]),
                  length(proxy_enet[proxy_enet %in% get(paste0("proxy_",col_name))]),
                  length(proxy_rf[proxy_rf %in% get(paste0("proxy_",col_name))]),
                  length(proxy_xgboost[proxy_xgboost %in% get(paste0("proxy_",col_name))]),
                  length(proxy_forward[proxy_forward %in% get(paste0("proxy_",col_name))]),
                  length(proxy_backward[proxy_backward %in% get(paste0("proxy_",col_name))]),
                  length(proxy_ga[proxy_ga %in% get(paste0("proxy_",col_name))]))
  proxy.common.1to1[i] <- c(na, num_common[i:10])
}

colnames(proxy.common.1to1) <- rownames(num.proxy_all)
rownames(proxy.common.1to1) <- rownames(num.proxy_all)

num.proxy_all
proxy.common.1to1
```

```{r results for OR, warning=FALSE, cache=TRUE, echo=FALSE}
sum.ci.OR_all <- rbind(sum.ci.OR_ks, sum.ci.OR_bross, sum.ci.OR_hybrid, 
                       sum.ci.OR_lasso, sum.ci.OR_enet, 
                       sum.ci.OR_rf, sum.ci.OR_xgboost, 
                       sum.ci.OR_forward, sum.ci.OR_backward, 
                       sum.ci.OR_ga)

OR_all <- data.frame(method = methods,
                     OR = sum.ci.OR_all[,1],
                     lower = exp(sum.ci.OR_all[,3]),
                     upper = exp(sum.ci.OR_all[,4]))

OR_all$method <- factor(OR_all$method, 
                        levels =  rev(methods))

OR.plot <- ggplot(OR_all, aes(y = method, x = OR)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2) + 
  geom_text(aes(label = num.proxy_all[,1], x = OR, y = method),
            vjust = -0.8,  # Adjust vertical position
            hjust = 1.8, # Adjust horizontal position
            size = 3, 
            color = "darkgreen") +
  geom_text(aes(label = as.vector(round(OR_all[2], 3))$OR, x = OR, y = method),
            vjust = -0.8,  # Adjust vertical position
            hjust = -0.3, # Adjust horizontal position
            size = 3, 
            color = "darkred") +
  labs(title = "Odds Ratios with 95% Confidence Intervals by Methods",
       x = "Odds Ratio",
       y = "Method")

custom_legend <- grobTree(
  textGrob("Number of proxies", x = 0.7, y = 0.1, hjust = 0, gp = gpar(col = "darkgreen", fontsize = 10)),
  textGrob("Odds Ratios", x = 0.1, y = 0.05, hjust = 0, gp = gpar(col = "darkred", fontsize = 10)))

custom_legend <- grobTree(
  rectGrob(x = 0.87, y = 0.93, 
           width = 0.22, height = 0.1,
           gp = gpar(fill = "white", col = "white")),
  rectGrob(x = 0.87, y = 0.93, 
           width = 0.22, height = 0.1,
           gp = gpar(col = "black")),
  textGrob("Number of Proxies", x = 0.775, y = 0.955, hjust = 0, gp = gpar(col = "darkgreen", fontsize = 10)),
  textGrob("Odds Ratios", x = 0.775, y = 0.91, hjust = 0, gp = gpar(col = "darkred", fontsize = 10))
)

OR.plot <- OR.plot + annotation_custom(custom_legend)

OR.plot
```

```{r results for RD, warning=FALSE, cache=TRUE, echo=FALSE}
sum.ci.RD_all <- rbind(sum.ci.RD_ks, sum.ci.RD_bross, sum.ci.RD_hybrid, 
                       sum.ci.RD_lasso, sum.ci.RD_enet, 
                       sum.ci.RD_rf, sum.ci.RD_xgboost, 
                       sum.ci.RD_forward, sum.ci.RD_backward, 
                       sum.ci.RD_ga)

RD_all <- data.frame(method = methods,
                     RD = sum.ci.RD_all[,1],
                     lower = sum.ci.RD_all[,3],
                     upper = sum.ci.RD_all[,4])

RD_all$method <- factor(RD_all$method, 
                        levels =  rev(methods))

RD.plot <- ggplot(RD_all, aes(y = method, x = RD)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2) + 
  geom_text(aes(label = num.proxy_all[,1], x = RD, y = method),
            vjust = -0.8,  # Adjust vertical position
            hjust = 1.8, # Adjust horizontal position
            size = 3, 
            color = "darkgreen") +
  geom_text(aes(label = as.vector(round(RD_all[2], 3))$RD, x = RD, y = method),
            vjust = -0.8,  # Adjust vertical position
            hjust = -0.3, # Adjust horizontal position
            size = 3, 
            color = "darkred") +
  labs(title = "Risk Difference with 95% Confidence Intervals by Methods",
       x = "Risk Difference",
       y = "Method")

custom_legend <- grobTree(
  rectGrob(x = 0.895, y = 0.93, 
           width = 0.19, height = 0.1,
           gp = gpar(fill = "white", col = "white")),
  rectGrob(x = 0.895, y = 0.93, 
           width = 0.19, height = 0.1,
           gp = gpar(col = "black")),
  textGrob("Number of Proxies", x = 0.812, y = 0.955, hjust = 0, gp = gpar(col = "darkgreen", fontsize = 9)),
  textGrob("Risk Difference", x = 0.812, y = 0.91, hjust = 0, gp = gpar(col = "darkred", fontsize = 9))
)

RD.plot <- RD.plot + annotation_custom(custom_legend)
RD.plot
```

```{r, cache=TRUE}
# save.image("RealDataAnalysisWorkspace.RData")
```

```{r, cache=TRUE}
ggplot2::ggsave("OR_plot.png", plot = OR.plot, device = "png", width = 8, height = 6)
ggplot2::ggsave("RD_plot.png", plot = RD.plot, device = "png", width = 8, height = 6)
```

```{r patchwork, warning=FALSE, cache=TRUE, echo=FALSE}
library(patchwork)
library(ggplot2)
# Combine the two plots
combined_plot <- OR.plot + RD.plot +
  plot_layout(ncol = 2, guides = "collect") &
  theme(legend.position = "none")
combined_plot
```


```{r patchworksave, warning=FALSE, cache=TRUE, echo=FALSE}
# Save the combined plot
ggplot2::ggsave("combined_OR_RD_plot0.png", plot = combined_plot, width = 12, height = 6, dpi = 300)

```

```{r, cache=TRUE}
library(ggplot2)
library(patchwork)

# Example: define human-readable names (must match order in 'methods')
method_names <- c(
  "Kitchen Sink", "Bross", "Hybrid", "LASSO", "Elastic Net",
  "Random Forest", "XGBoost", "Forward Selection",
  "Backward Elimination", "Genetic Algorithm"
)

# Create composite labels using real number of proxies
method_labels <- paste0(method_names, " [", num.proxy_all[, 1], "]")

# Rank indices by proxy count (descending order)
rank_idx <- order(num.proxy_all[, 1], decreasing = TRUE)

# Reorder everything based on that rank
method_labels <- method_labels[rank_idx]
#OR_all$method <- factor(method_labels, levels = method_labels)
#RD_all$method <- factor(method_labels, levels = method_labels)

# Apply ordered factor with labels
OR_all$method <- factor(method_labels, levels = rev(method_labels))
RD_all$method <- factor(method_labels, levels = rev(method_labels))

# Plot: OR
OR_all

OR.plot <- ggplot(OR_all, aes(y = method, x = OR)) +
  geom_point(size = 3, color = "black") +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, color = "black") +
  geom_text(aes(label = round(OR, 2), x = OR + 0.015), vjust = -0.6, size = 3) +
  labs(title = "", x = "Odds Ratio", y = "Method [Chosen number of proxies]") +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 9)
  )



# Plot: RD
RD_all

RD.plot <- ggplot(RD_all, aes(y = method, x = RD)) +
  geom_point(size = 3, color = "black") +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, color = "black") +
  geom_text(aes(label = round(RD, 2), x = RD + 0.003), vjust = -0.6, size = 3) +
  labs(title = "", x = "Risk Difference", y = NULL) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


# Combine plots side-by-side
combined_plot2 <- OR.plot + RD.plot +
  plot_layout(ncol = 2, widths = c(1.1, 1))

# Display
combined_plot2

```

```{r patchworksave2, warning=FALSE, echo=FALSE}
# Save the combined plot
ggplot2::ggsave("combined_OR_RD_plot.png", plot = combined_plot2, width = 12, height = 6, dpi = 300)

```